name: Code Quality & Build Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard eslint

      - name: Create config files
        run: |
          # HTMLHint config
          cat > .htmlhintrc << 'EOF'
          {
            "tagname-lowercase": true,
            "attr-lowercase": true,
            "attr-value-double-quotes": true,
            "doctype-first": false,
            "tag-pair": true,
            "spec-char-escape": true,
            "id-unique": true,
            "src-not-empty": true,
            "alt-require": true,
            "title-require": true
          }
          EOF

          # StyleLint config
          cat > .stylelintrc.json << 'EOF'
          {
            "extends": "stylelint-config-standard",
            "rules": {
              "selector-class-pattern": null,
              "custom-property-pattern": null,
              "no-descending-specificity": null,
              "font-family-no-missing-generic-family-keyword": null
            }
          }
          EOF

          # ESLint config
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": "latest",
              "sourceType": "module"
            },
            "rules": {
              "no-unused-vars": "warn",
              "no-console": "off"
            }
          }
          EOF

      - name: Lint HTML files
        continue-on-error: true
        run: |
          echo "::group::HTML Linting"
          htmlhint "**/*.html" || true
          echo "::endgroup::"

      - name: Lint CSS files
        continue-on-error: true
        run: |
          echo "::group::CSS Linting"
          stylelint "**/*.css" --allow-empty-input || true
          echo "::endgroup::"

      - name: Lint JavaScript files
        continue-on-error: true
        run: |
          echo "::group::JavaScript Linting"
          eslint "**/*.js" --no-error-on-unmatched-pattern || true
          echo "::endgroup::"

      - name: Check for broken links in HTML
        run: |
          echo "::group::Checking file references"
          python3 << 'PYTHON_SCRIPT'
          import os
          import re
          import sys
          
          errors = []
          warnings = []
          
          def check_file_exists(base_path, ref_path):
              # Remove query strings and anchors
              clean_path = ref_path.split('?')[0].split('#')[0]
              
              # Skip external URLs
              if clean_path.startswith(('http://', 'https://', '//', 'mailto:', 'tel:')):
                  return True
              
              # Handle absolute paths from root
              if clean_path.startswith('/'):
                  full_path = os.path.join('.', clean_path.lstrip('/'))
              else:
                  # Handle relative paths
                  full_path = os.path.join(os.path.dirname(base_path), clean_path)
              
              full_path = os.path.normpath(full_path)
              return os.path.exists(full_path)
          
          # Check HTML files
          for root, dirs, files in os.walk('.'):
              # Skip node_modules and .git
              dirs[:] = [d for d in dirs if d not in ['.git', 'node_modules', '.github']]
              
              for file in files:
                  if file.endswith('.html'):
                      filepath = os.path.join(root, file)
                      
                      try:
                          with open(filepath, 'r', encoding='utf-8') as f:
                              content = f.read()
                          
                          # Check src attributes
                          src_refs = re.findall(r'(?:src|href)=["\']((?!data:)[^"\']+)["\']', content)
                          
                          for ref in src_refs:
                              if not check_file_exists(filepath, ref):
                                  if ref.startswith(('http://', 'https://')):
                                      warnings.append(f"âš ï¸  {filepath}: External reference {ref}")
                                  else:
                                      errors.append(f"âŒ {filepath}: Missing file {ref}")
                      
                      except Exception as e:
                          warnings.append(f"âš ï¸  Could not read {filepath}: {e}")
          
          if errors:
              print("\nðŸ”´ ERRORS FOUND:")
              for error in errors:
                  print(error)
          
          if warnings:
              print("\nðŸŸ¡ WARNINGS:")
              for warning in warnings[:10]:  # Limit warnings
                  print(warning)
              if len(warnings) > 10:
                  print(f"... and {len(warnings) - 10} more warnings")
          
          if not errors and not warnings:
              print("âœ… All file references validated successfully!")
          
          # Don't fail the build for now, just report
          sys.exit(0)
          PYTHON_SCRIPT
          echo "::endgroup::"

      - name: Validate JSON files
        run: |
          echo "::group::Validating JSON files"
          for file in $(find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/.git/*"); do
            echo "Checking $file"
            python3 -m json.tool "$file" > /dev/null || echo "âŒ Invalid JSON: $file"
          done
          echo "::endgroup::"

      - name: Check for common issues
        run: |
          echo "::group::Common Issues Check"
          
          echo "ðŸ“‹ Checking for console.log in production code..."
          if grep -r "console\.log\|console\.error\|debugger" --include="*.js" --exclude-dir=node_modules . ; then
            echo "âš ï¸  Found console statements (consider removing for production)"
          else
            echo "âœ… No console statements found"
          fi
          
          echo ""
          echo "ðŸ“‹ Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.js" --include="*.css" --include="*.html" --exclude-dir=node_modules . ; then
            echo "âš ï¸  Found TODO/FIXME comments"
          else
            echo "âœ… No pending TODOs found"
          fi
          
          echo ""
          echo "ðŸ“‹ Checking file sizes..."
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" \) -not -path "*/node_modules/*" -size +500k -exec ls -lh {} \; | awk '{print "âš ï¸  Large file: " $9 " (" $5 ")"}'
          
          echo "::endgroup::"

      - name: Build summary
        if: always()
        run: |
          echo "## ðŸ“Š Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Quality checks completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Checked:" >> $GITHUB_STEP_SUMMARY
          echo "- HTML: $(find . -name '*.html' -not -path '*/node_modules/*' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- CSS: $(find . -name '*.css' -not -path '*/node_modules/*' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- JS: $(find . -name '*.js' -not -path '*/node_modules/*' | wc -l) files" >> $GITHUB_STEP_SUMMARY

  vercel-preview:
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Comment PR with preview
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Vercel Preview: Check your deployment at Vercel dashboard'
            })
